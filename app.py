
# v2.0
# app.py
import streamlit as st
from multi_agent import(run_sync,chat_with_gpt)
import streamlit as st
import os
from dotenv import load_dotenv
import streamlit_authenticator as stauth

st.set_page_config(page_title="multi_agent")


# st.write("""###### PMIé–¢é€£ã®è³ªå•ã«å›ç­”ã—ã¦ãã‚Œã‚‹ã‚¢ã‚·ã‚¹ã‚¿ãƒ³ãƒˆAIã§ã™ã€‚\n
# ###### Graphãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã¨ãƒ™ã‚¯ãƒˆãƒ«ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚’åˆ©ç”¨ã—ãŸãƒã‚¤ãƒ–ãƒªãƒƒãƒ‰RAGã‚·ã‚¹ãƒ†ãƒ ã‚’æ¡ç”¨ã—ã¦ã„ã¾ã™ã€‚
#         """)

hashed_pw = stauth.Hasher([os.getenv("APP_PASSWORD")]).generate()[0]

config = {
    "credentials": {
        "usernames": {
            os.getenv("APP_USER"): {
                "name" : "user",
                "password": hashed_pw,
                # "roles": ["admin"],
            },
            os.getenv("APP_USER2"): {
                "name" : "rag",
                "password": hashed_pw,
                # "roles": ["admin"],
            },
        }
    },
    "cookie": {
        "name":  "app_auth",
        "key":   os.getenv("COOKIE_KEY"),          # ãƒ©ãƒ³ãƒ€ãƒ æ–‡å­—åˆ—ã‚’ Secrets ã§æ³¨å…¥
        "expiry_days": int(3),
    },
}

authenticator = stauth.Authenticate(config["credentials"],
                                    cookie_name=config["cookie"]["name"],
                                    cookie_key=config["cookie"]["key"],
                                    cookie_expiry_days=config["cookie"]["expiry_days"])


# ãƒ­ã‚°ã‚¤ãƒ³ãƒ•ã‚©ãƒ¼ãƒ ã®è¡¨ç¤ºï¼ˆã“ã“ã§å…¥åŠ›æ¬„ãŒå‡ºã‚‹ï¼‰
name, auth_status, username = authenticator.login(location='main', fields={'Form name': 'PMIã‚¢ã‚·ã‚¹ã‚¿ãƒ³ãƒˆAI\nãƒ­ã‚°ã‚¤ãƒ³ç”»é¢','Login': 'ãƒ­ã‚°ã‚¤ãƒ³'})

# èªè¨¼çµæœã«å¿œã˜ã¦ã‚¢ãƒ—ãƒªã®è¡¨ç¤ºã‚’åˆ‡ã‚Šæ›¿ãˆã‚‹
if auth_status:
    st.info("""### PMIã‚¢ã‚·ã‚¹ã‚¿ãƒ³ãƒˆAI
         - PMIé–¢é€£ã®è³ªå•ã«å›ç­”ã—ã¦ãã‚Œã‚‹ã‚¢ã‚·ã‚¹ã‚¿ãƒ³ãƒˆAIã§ã™
    - Graphãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã¨ãƒ™ã‚¯ãƒˆãƒ«ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚’åˆ©ç”¨ã—ãŸãƒã‚¤ãƒ–ãƒªãƒƒãƒ‰RAGã‚·ã‚¹ãƒ†ãƒ ã‚’æ¡ç”¨ã—ã¦ã„ã¾ã™ã€‚
    - ä½¿ã„æ–¹/è³ªå•ä¾‹
        âœ“ è£½é€ æ¥­ã®PMIã‚’è¨ˆç”»ã—ã¦ã„ã¾ã™ã€‚éå»ã®æ¡ˆä»¶ã‹ã‚‰æ¤œè¨ã™ã¹ãè«–ç‚¹ã‚’æ•™ãˆã¦ãã ã•ã„ã€‚
        âœ“ è²·åå…ˆã®ITã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒãƒªã‚·ãƒ¼ãŒæ¥µã‚ã¦ç·©ãã€ã‚¦ã‚¤ãƒ«ã‚¹æ¤œçŸ¥ã‚„IDç®¡ç†ãŒä¸ååˆ†ã§ã™ã€‚
         ã€€Day30ã¾ã§ã«è¬›ã˜ã‚‹ã¹ãæœ€ä½é™ã®å¯¾ç­–ã¯ä½•ã§ã™ã‹ï¼Ÿ
        âœ“ ä¼šè¨ˆãƒãƒªã‚·ãƒ¼ã®çµ±ä¸€ã«é–¢ã—ã¦ã€éå»ã®æ¡ˆä»¶åŠã³è«–ç‚¹ã‚’å…¨ã¦æ•™ãˆã¦ãã ã•ã„ã€‚
        âœ“ ITã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ä½“åˆ¶ãŒè²·åå…ˆã«å­˜åœ¨ã—ãªã„å ´åˆã€PMIã§æœ€åˆã«å®Ÿæ–½ã™ã¹ãã‚¹ãƒ†ãƒƒãƒ—ã¯ï¼Ÿ""")
    st.warning("""
###### â€»å‚ç…§ã—ã¦ã„ã‚‹æ›¸é¡ã¯ã€å…¨ã¦ç”ŸæˆAIã§ä½œæˆã—ãŸæ¶ç©ºã®è³‡æ–™ãƒ»æ¡ˆä»¶ãƒ¡ãƒ¢ã§ã™ã€‚
""")
    st.sidebar.write(f"ãƒ¦ãƒ¼ã‚¶ãƒ¼ï¼š{username}")
    authenticator.logout(location='sidebar')
    st.sidebar.divider()
    st.sidebar.markdown("""
### å‚ç…§ã—ã¦ã„ã‚‹è³‡æ–™ãƒ»æ¡ˆä»¶ãƒ¡ãƒ¢ä¸€è¦§
###### 1.PMIãƒã‚¤ãƒ«ã‚¹ãƒˆãƒ¼ãƒ³ãƒªã‚¹ãƒˆï¼ˆä¼šè¨ˆç¨å‹™/IT/äººäº‹/æ³•å‹™ï¼‰
###### 2.å›½å†…ç‰©æµä¼æ¥­ã«ã‚ˆã‚‹ITé–¢é€£å­ä¼šç¤¾ã®è²·åã«ä¼´ã†ã‚¯ãƒ­ã‚¹ãƒ•ã‚¡ãƒ³ã‚¯ã‚·ãƒ§ãƒŠãƒ«PMIæ•´ç†ãƒ¡ãƒ¢
###### 3.æµ·å¤–M&Aã«ã‚ˆã‚‹è£½é€ å­ä¼šç¤¾ã®è²·åã«ä¼´ã†PMIå®Ÿå‹™æ•´ç†ãƒ¡ãƒ¢
###### 4.æ¬§å·æ‹ ç‚¹ã®è£½è–¬ä¼æ¥­è²·åã«ä¼´ã†PMIè«–ç‚¹æ•´ç†ãƒ¡ãƒ¢ï¼ˆæ©Ÿèƒ½åˆ¥èª²é¡Œã¨å®Ÿè¡Œä¸Šã®ç¤ºå”†ï¼‰
###### 5.åŒ—ç±³åŒ»ç™‚æ©Ÿå™¨ãƒ¡ãƒ¼ã‚«ãƒ¼è²·åã«ä¼´ã†çµ±åˆå®Ÿå‹™ã«é–¢ã™ã‚‹PMIæ¡ˆä»¶æ•´ç†ãƒ¡ãƒ¢
###### 6.å›½å†…è£½é€ æ¥­ã«ã‚ˆã‚‹ç•°æ¥­ç¨®ãƒ™ãƒ³ãƒãƒ£ãƒ¼è²·åã«ãŠã‘ã‚‹PMIè«–ç‚¹æ•´ç†ãƒ¡ãƒ¢
###### 7.ä¸­å …ã‚¨ãƒãƒ«ã‚®ãƒ¼å•†ç¤¾ã«ã‚ˆã‚‹å†ç”Ÿå¯èƒ½ã‚¨ãƒãƒ«ã‚®ãƒ¼äº‹æ¥­ä¼šç¤¾è²·åã«é–¢ã™ã‚‹PMIæ¡ˆä»¶
###### 8.å›½å†…ITã‚µãƒ¼ãƒ“ã‚¹ä¼æ¥­ã«ã‚ˆã‚‹åœ°æ–¹é‡‘èæ©Ÿé–¢å‘ã‘ã‚½ãƒªãƒ¥ãƒ¼ã‚·ãƒ§ãƒ³ä¼šç¤¾ã®è²·åã«ãŠã‘ã‚‹PMI
###### 9.æ—¥ç³»å•†ç¤¾ã«ã‚ˆã‚‹ç‰©æµã‚¹ã‚¿ãƒ¼ãƒˆã‚¢ãƒƒãƒ—è²·åã«é–¢ã™ã‚‹PMIæ¡ˆä»¶
###### 10.è£½é€ æ¥­ã«ã‚ˆã‚‹åŒæ¥­çµ±åˆã«ãŠã‘ã‚‹ä¼šè¨ˆãƒ»æ¥­å‹™ãƒ»ç®¡ç†ä½“åˆ¶ã®PMI
###### 11.æ¬§å·BPOä¼æ¥­è²·åã«ä¼´ã†æ©Ÿèƒ½åˆ¥çµ±åˆãƒãƒã‚¸ãƒ¡ãƒ³ãƒˆã®å®Ÿå‹™æ•´ç†ãƒ¡ãƒ¢
###### 12.åŒ—ç±³å­ä¼šç¤¾çµ±åˆã«ä¼´ã†è«–ç‚¹æ•´ç†
###### 13.æ¬§å·è£½é€ æ¥­è²·åå¾Œã«ãŠã‘ã‚‹ã‚°ãƒ«ãƒ¼ãƒ—å†…åˆ¶åº¦æ•´å‚™ã¨æ—©æœŸå®‰å®šåŒ–ã«é–¢ã™ã‚‹è«–ç‚¹æ•´ç†
###### 14.ã‚°ãƒ­ãƒ¼ãƒãƒ«è£½é€ æ¥­ã®è²·åå¾ŒDay360ãƒ•ã‚§ãƒ¼ã‚ºã«ãŠã‘ã‚‹åˆ¶åº¦çµ±åˆã¨ã‚·ãƒŠã‚¸ãƒ¼å®Ÿç¾ã®ãŸã‚ã®è«–ç‚¹æ•´ç†
###### 15.å›½å†…ç‰©æµæ¥­ç•Œã®è²·åæ¡ˆä»¶ã«ãŠã‘ã‚‹åˆæœŸPMIãƒ•ã‚§ãƒ¼ã‚ºã«ãŠã‘ã‚‹åˆ¶åº¦æ•´å‚™ã¨é–¢ä¿‚æ§‹ç¯‰ã®è«–ç‚¹æ•´ç†
###### 16.æ¥­å‹™ãƒ—ãƒ­ã‚»ã‚¹ã¨ã‚·ã‚¹ãƒ†ãƒ åŸºç›¤ã®èåˆã‚’è»¸ã¨ã—ãŸPMIå®Ÿè¡Œæ¡ˆä»¶æ•´ç†ãƒ¡ãƒ¢
###### 17.ãƒ‡ãƒ¼ã‚¿ãƒ»åˆ¶åº¦ãƒ»äººæã®èåˆã‚’è»¸ã¨ã—ãŸä¸­å …ITä¼æ¥­ã®çµ±åˆæ¡ˆä»¶æ•´ç†
###### 18.å¤§æ‰‹è£½è–¬ä¼æ¥­ã«ã‚ˆã‚‹ãƒã‚¤ã‚ªãƒ™ãƒ³ãƒãƒ£ãƒ¼è²·åå¾Œã®ç®¡ç†åŸºç›¤çµ±åˆã«å‘ã‘ãŸPMIå¯¾å¿œ
###### 19.å›½å†…å¤§æ‰‹è£½é€ æ¥­ã«ã‚ˆã‚‹ä¸­å …ITä¼æ¥­è²·åå¾Œã®ãƒªã‚¹ã‚¯çµ±åˆãƒ»äººæå¼·åŒ–ã‚’é‡è¦–ã—ãŸPMIæ¨é€²
###### 20.æ¬§å·ITã‚¤ãƒ³ãƒ•ãƒ©ä¼æ¥­ã®è²·åã«ä¼´ã†PMIè¨ˆç”»ã«é–¢ã™ã‚‹è«–ç‚¹æ•´ç†
###### 21.æµ·å¤–å­ä¼šç¤¾è²·åå¾Œã®ä¼šè¨ˆé ˜åŸŸã«ãŠã‘ã‚‹çµ±åˆä½œæ¥­ã«é–¢ã™ã‚‹PMIæ¡ˆä»¶æ•´ç†ãƒ¡ãƒ¢
###### 22.ã‚¢ã‚¯ã‚·ã‚ªãƒ³ãƒ»ã‚°ãƒ«ãƒ¼ãƒ—ã«ã‚ˆã‚‹æµ·å¤–åŒ»ç™‚æ©Ÿå™¨ãƒ¡ãƒ¼ã‚«ãƒ¼ã€Œãƒ¡ãƒ‡ã‚£ãƒˆãƒ­ãƒ³ç¤¾ã€ã®è²·åå¾ŒPMIæ¡ˆä»¶
###### 23.ã‚¢ã‚µãƒ’ãƒ†ã‚¯ã‚¹æ ªå¼ä¼šç¤¾ã«ã‚ˆã‚‹ãƒ™ãƒˆãƒŠãƒ ã®æ¨¹è„‚è£½å“ãƒ¡ãƒ¼ã‚«ãƒ¼ã®è²·åå¾Œçµ±åˆï¼ˆPMIï¼‰æ•´ç†ãƒ¡ãƒ¢
###### 24.ã‚°ãƒ­ãƒ¼ãƒãƒ«é›»æ©Ÿéƒ¨å“ãƒ¡ãƒ¼ã‚«ãƒ¼ã«ã‚ˆã‚‹ã‚¤ãƒ³ãƒ‰æ‹ ç‚¹ã®M&A
###### 25.ã‚µãƒ³ã‚¨ãƒ¬ã‚¯ãƒˆãƒ­ãƒ‹ã‚¯ã‚¹æ ªå¼ä¼šç¤¾ã«ã‚ˆã‚‹ãƒˆãƒ«ã‚³åŠå°ä½“ãƒ¡ãƒ¼ã‚«ãƒ¼ã®è²·åã¨PMIå®Ÿè¡Œã«é–¢ã™ã‚‹æ¡ˆä»¶æ•´ç†ãƒ¡ãƒ¢
###### 26.ãƒ©ã‚¤ãƒ•ãƒ­ã‚¸ãƒƒã‚¯ã‚¹æ ªå¼ä¼šç¤¾ã«ã‚ˆã‚‹å—ç±³åŒ»è–¬å“ç‰©æµä¼æ¥­ã®è²·åã¨PMIçµ±åˆè¨ˆç”»
###### 27.æ—¥æœ¬ã‚¤ãƒ¼ã‚³ãƒãƒ¼ã‚¹æ ªå¼ä¼šç¤¾ã«ã‚ˆã‚‹ç±³å›½ECãƒ—ãƒ©ãƒƒãƒˆãƒ•ã‚©ãƒ¼ãƒ ä¼æ¥­è²·åå¾Œã®çµ±åˆå¯¾å¿œè¨˜éŒ²
###### 28.ã‚¢ã‚¸ã‚¢ãƒ©ã‚¤ãƒ•ãƒ›ãƒ¼ãƒ«ãƒ‡ã‚£ãƒ³ã‚°ã‚¹ã«ã‚ˆã‚‹ãƒ¡ãƒ‡ã‚£ãƒ•ãƒ¥ãƒ¼ãƒãƒ£ãƒ¼ç¤¾è²·åã«ãŠã‘ã‚‹åˆæœŸçµ±åˆæ–½ç­–ãƒ¡ãƒ¢
###### 29.ã‚½ãƒ©ã‚¤ãƒ¡ãƒ‡ã‚£ã‚«ãƒ«ã«ã‚ˆã‚‹ã‚¨ã‚³ãƒ•ã‚£ãƒ«ãƒ ç¤¾è²·åå¾Œã®çµ±åˆåˆæœŸå¯¾å¿œãƒ¡ãƒ¢
###### 30.ã‚¢ã‚¹ã‚¿ãƒªã‚¯ã‚¹ç¤¾ã«ã‚ˆã‚‹ãƒ†ã‚¯ãƒãƒ¬ã‚¤ãƒ³ç¤¾è²·åã«ä¼´ã†æ©Ÿèƒ½çµ±åˆãƒ¡ãƒ¢
###### 31.ã‚·ã‚°ãƒŠã‚¹ç‰©æµã«ã‚ˆã‚‹ã‚°ãƒ­ãƒ¼ãƒãƒ«å€‰åº«é‹å–¶ä¼šç¤¾ã®è²·åæ¡ˆä»¶æ•´ç†ãƒ¡ãƒ¢
                                                """)








# st.set_page_config(page_title="AutoGen è­°è«–ãƒãƒ£ãƒƒãƒˆ", layout="centered")
# st.title("ğŸ¤– AIã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã¨è­°è«–ã—ã‚ˆã†")






    # â€”â€”â€” ã‚»ãƒƒã‚·ãƒ§ãƒ³ã®åˆæœŸåŒ– â€”â€”â€”
    if "qa_history" not in st.session_state:
        # å„è³ªå•ã”ã¨ã« { "question": str, "responses": list[(sender,content)] } ã‚’ä¿å­˜
        st.session_state.qa_history = []

    # â€”â€”â€” ã“ã‚Œã¾ã§ã® QA ãƒšã‚¢ã‚’è¡¨ç¤º â€”â€”â€”
    for entry in st.session_state.qa_history:
        # ãƒ¦ãƒ¼ã‚¶ãƒ¼è³ªå•
        with st.chat_message("user"):
            st.markdown(entry["question"])
        # å¯¾å¿œã™ã‚‹ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆå¿œç­”ã‚’æŠ˜ã‚ŠãŸãŸã¿è¡¨ç¤º
        with st.expander("ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã®ç™ºè¨€", expanded=False):
            for sender, msg in entry["responses"]:
                st.markdown(f"**{sender}**: {msg}")
        with st.chat_message("assistant"):
            st.markdown(entry["answer"])

    # ãƒ¦ãƒ¼ã‚¶ãƒ¼å…¥åŠ›
    user_input = st.chat_input("ğŸ’¬ è­°è«–ã—ãŸã„å†…å®¹ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„")

    if user_input:
        # ãƒ¦ãƒ¼ã‚¶ãƒ¼ç™ºè¨€ã‚’è¨˜éŒ²ï¼†è¡¨ç¤º
        st.session_state.qa_history.append({
            "question": user_input,
            "responses": [],
            "answer":[]
        })
        with st.chat_message("user"):
            st.markdown(user_input)

        # â€œç¾åœ¨ç™ºè¨€ä¸­ã®ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆâ€ ã‚’å·®ã—æ›¿ãˆã‚‹ãƒ—ãƒ¬ãƒ¼ã‚¹ãƒ›ãƒ«ãƒ€ãƒ¼
        placeholder = st.empty()

        with st.spinner("ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆãŸã¡ãŒè­°è«–ã—ã¦ã„ã¾ã™..."):
            temp_logs = []
            def handle_message(sender: str, content: str):
                st.session_state.qa_history[-1]["responses"].append((sender, content))
                temp_logs.append((sender, content))
                # å‰ã®ç™ºè¨€ã‚’ã‚¯ãƒªã‚¢ã—ã¦ã€æ–°ã—ã„ç™ºè¨€ã ã‘è¡¨ç¤º
                placeholder.empty()
                # 1) æœ€åˆã®3è¡Œã ã‘æŠœãå‡ºã—ã¦ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼
                lines = content.splitlines()
                preview = lines[:5]
                if len(lines) > 5:
                    preview.append("ãƒ»ãƒ»ãƒ»ãƒ»ãƒ»")

                # 2) ç™ºè¨€è€…åã¨ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚’çµåˆ
                preview_text = "\n".join(preview)
                full_preview = f"{sender}: {preview_text}"

                # 3) å„è¡Œã‚’ãƒ–ãƒ­ãƒƒã‚¯å¼•ç”¨ã«
                quoted = "\n".join(f"> {line}" for line in full_preview.splitlines())

                placeholder.markdown(quoted)

            run_sync(user_input, handle_message)
            final_answer = chat_with_gpt(user_input,temp_logs)

        with st.expander("ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã®ç™ºè¨€",expanded=False):
            placeholder.empty()
            for role, message in temp_logs:
                st.markdown(f"**{role}**: {message}")
        with st.chat_message("assistant"):
            st.markdown(final_answer)

        st.session_state.qa_history[-1]["answer"].append((final_answer))

elif auth_status is False:
    st.error("ãƒ¦ãƒ¼ã‚¶ãƒ¼åã¾ãŸã¯ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒé–“é•ã£ã¦ã„ã¾ã™ã€‚")
elif auth_status is None:
    st.info("ãƒ¦ãƒ¼ã‚¶ãƒ¼åã¨ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚")
